
# Kiro CLI pre block. Keep at the top of this file.
[[ -f "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.pre.zsh" ]] && builtin source "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.pre.zsh"

# ============================================================================
# Amazon Q Integration (Pre-initialization)
# ============================================================================
# NOTE: Keep at the top of this file
[[ -f "${HOME}/Library/Application Support/amazon-q/shell/zshrc.pre.zsh" ]] && \
    builtin source "${HOME}/Library/Application Support/amazon-q/shell/zshrc.pre.zsh"


# ============================================================================
# Zplug Plugin Manager
# ============================================================================
source ~/.zplug/init.zsh


# ----------------------------------------------------------------------------
# Zsh Enhancement Plugins
# ----------------------------------------------------------------------------
# Fish-like features (defer:2/3 to ensure proper loading order)
zplug 'zsh-users/zsh-syntax-highlighting', defer:2
zplug 'zsh-users/zsh-history-substring-search', defer:3
zplug 'zsh-users/zsh-autosuggestions'
zplug 'zsh-users/zsh-completions', depth:1

# Optional: Enable 256-color mode if needed
#zplug 'chrissicool/zsh-256color'


# ----------------------------------------------------------------------------
# Utility Plugins
# ----------------------------------------------------------------------------
# Directory warp points
zplug 'mfaerevaag/wd', as:command, use:'wd.sh', \
    hook-load:"wd() { . $ZPLUG_REPOS/mfaerevaag/wd/wd.sh }"

# Command-line utilities
zplug "Jxck/dotfiles", as:command, use:"bin/{histuniq,color}"
zplug "k4rthik/git-cal", as:command, frozen:1
zplug "b4b4r07/httpstat", as:command, use:'(*).sh', rename-to:'$1'

# Docker aliases
zplug "tcnksm/docker-alias", use:zshrc

# Enhanced directory navigation
zplug "b4b4r07/enhancd", at:v1
zplug "mollifier/anyframe", at:4c23cb60

# Gist and Bitbucket utilities
zplug "b4b4r07/79ee61f7c140c63d2786", from:gist, as:command, use:get_last_pane_path.sh
zplug "b4b4r07/hello_bitbucket", from:bitbucket, as:command, use:"*.sh"

# Enhanced vim mode
zplug "softmoth/zsh-vim-mode", defer:3

# SSH utilities
zplug "zpm-zsh/ssh"


# ----------------------------------------------------------------------------
# Oh-My-Zsh Plugins
# ----------------------------------------------------------------------------
# Ref: https://ithelp.ithome.com.tw/articles/10192899?sc=pt

# Active plugins
zplug "plugins/git", from:oh-my-zsh
zplug "plugins/docker", from:oh-my-zsh
zplug "plugins/vagrant", from:oh-my-zsh
zplug "plugins/docker-compose", from:oh-my-zsh

# Oh-My-Zsh core libraries (excluding completion to avoid conflicts)
zplug "lib/spectrum", from:oh-my-zsh
zplug "lib/directories", from:oh-my-zsh
zplug "lib/functions", from:oh-my-zsh
zplug "lib/history", from:oh-my-zsh
zplug "lib/clipboard", from:oh-my-zsh, if:"[[ $OSTYPE == *darwin* ]]"

# Disabled plugins (uncomment if needed)
#zplug "plugins/node", from:oh-my-zsh
#zplug "plugins/npm", from:oh-my-zsh
#zplug "plugins/python", from:oh-my-zsh
#zplug "plugins/pip", from:oh-my-zsh
#zplug "plugins/pyenv", from:oh-my-zsh
#zplug "plugins/virtualenvwrapper", from:oh-my-zsh
#zplug "plugins/osx", from:oh-my-zsh
#zplug "plugins/fasd", from:oh-my-zsh
#zplug "plugins/cargo", from:oh-my-zsh


# ----------------------------------------------------------------------------
# Theme
# ----------------------------------------------------------------------------
zplug 'dracula/zsh', as:theme


# ----------------------------------------------------------------------------
# Plugin Installation & Loading
# ----------------------------------------------------------------------------
if ! zplug check --verbose; then
    printf "Install? [y/N]: "
    if read -q; then
        echo; zplug install
    fi
fi

zplug load

# ============================================================================
# Zsh Completion System Initialization
# ============================================================================
# Clear any existing completion cache to avoid conflicts
rm -f ~/.zcompdump* 2>/dev/null

# Add local functions directory first (for custom stubs)
fpath=(~/.zsh/functions /usr/share/zsh/5.9/functions /opt/homebrew/share/zsh/site-functions $fpath)

# Initialize completion system after plugins are loaded
autoload -Uz compinit
compinit -d ~/.zcompdump

# Load essential completion functions with error handling
autoload -Uz _arguments 2>/dev/null || true
autoload -Uz comparguments 2>/dev/null || true

# Set completion options
setopt COMPLETE_IN_WORD
setopt AUTO_MENU
setopt AUTO_LIST
setopt AUTO_PARAM_SLASH
unsetopt MENU_COMPLETE

# Enable completion caching
zstyle ':completion::complete:*' use-cache 1
zstyle ':completion::complete:*' cache-path ~/.zsh/cache

# Suppress completion errors completely
zstyle ':completion:*' verbose false
zstyle ':completion:*' group-name ''
zstyle ':completion:*:warnings' format ''

# Disable problematic completions that cause _arguments errors
zstyle ':completion:*' completer _complete _ignored
zstyle ':completion:*' matcher-list 'm:{a-z}={A-Z}'

# Override _arguments function to prevent comparguments errors
_arguments() {
    # Simple fallback that just completes files
    _files
}

# Fix git completion specifically (common source of _arguments errors)
zstyle ':completion:*:*:git:*' script /opt/homebrew/share/zsh/site-functions/_git 2>/dev/null || true


# ============================================================================
# Environment Variables
# ============================================================================

# ----------------------------------------------------------------------------
# Path Configuration
# ----------------------------------------------------------------------------
export ZPLUG_HOME=$HOME/Documents/dotfiles/zsh/zplug
export PATH="$HOME/.local/bin:/usr/local/bin:$PATH:$HOME/usr/bin:$ZPLUG_HOME/bin"

# ----------------------------------------------------------------------------
# Locale Settings
# ----------------------------------------------------------------------------
# Workaround for vim + Syntastic + pylint
export LC_CTYPE=en_US.UTF-8
export LANG=en_US

# ----------------------------------------------------------------------------
# Homebrew
# ----------------------------------------------------------------------------
eval "$(/opt/homebrew/bin/brew shellenv)"


# ============================================================================
# Zsh Configuration
# ============================================================================

# ----------------------------------------------------------------------------
# Vi Mode Settings
# ----------------------------------------------------------------------------
# Ref: https://jdhao.github.io/2019/02/19/zsh_advanced_configuration/
bindkey -v
keytimeout=1

# Cursor styles
MODE_CURSOR_VICMD="green block"
MODE_CURSOR_VIINS="#20d08a blinking bar"
MODE_CURSOR_SEARCH="#ff00ff blinking underline"

# Mode indicators
MODE_INDICATOR_VIINS='%F{15}[%F{15}I]%f'
MODE_INDICATOR_VICMD='%F{10}[%F{10}N]%f'
MODE_INDICATOR_REPLACE='%F{9}[%F{9}R]%f'
MODE_INDICATOR_SEARCH='%F{13}[%F{13}S]%f'
MODE_INDICATOR_VISUAL='%F{12}[%F{12}V]%f'
MODE_INDICATOR_VLINE='%F{12}[%F{12}V-LINE]%f'


# ============================================================================
# Tool Integrations
# ============================================================================

# ----------------------------------------------------------------------------
# FZF - Fuzzy Finder
# ----------------------------------------------------------------------------
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# ----------------------------------------------------------------------------
# Language Version Managers - Modern Stack
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Language Version Managers - Modern Stack
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Language Version Managers - Modern Stack
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Language Version Managers - Modern Stack
# ----------------------------------------------------------------------------

# Python - UV (replaces pyenv, pip, poetry, pipx)
if command -v uv &> /dev/null; then
    # Add uv to PATH
    export PATH="$HOME/.local/bin:$PATH"
    
    # Configure uv Python path management
    export UV_PYTHON_PREFERENCE="only-managed"
    
    # Add uv tool binaries to PATH (for globally installed tools)
    if [ -d "$HOME/.local/share/uv/tools" ]; then
        export PATH="$HOME/.local/share/uv/tools:$PATH"
    fi
    
    # Enable uv shell completion
    eval "$(uv generate-shell-completion zsh)"
    
    # Create UV Python shims directory
    UV_SHIMS_DIR="$HOME/.local/share/uv/shims"
    mkdir -p "$UV_SHIMS_DIR"
    
    # Add UV shims to PATH (highest priority)
    export PATH="$UV_SHIMS_DIR:$PATH"
    
    # Create smart Python shims that use UV's .python-version detection
    _create_uv_shims() {
        # Python shim
        cat > "$UV_SHIMS_DIR/python" << 'EOF'
#!/bin/bash
# UV Python shim - automatically detects .python-version
uv_python=$(uv python find 2>/dev/null)
if [ -n "$uv_python" ]; then
    exec "$uv_python" "$@"
else
    exec /opt/homebrew/bin/python3 "$@" 2>/dev/null || exec /usr/bin/python3 "$@"
fi
EOF
        
        # Python3 shim
        cat > "$UV_SHIMS_DIR/python3" << 'EOF'
#!/bin/bash
# UV Python3 shim - automatically detects .python-version
uv_python=$(uv python find 2>/dev/null)
if [ -n "$uv_python" ]; then
    exec "$uv_python" "$@"
else
    exec /opt/homebrew/bin/python3 "$@" 2>/dev/null || exec /usr/bin/python3 "$@"
fi
EOF
        
        # Pip shim
        cat > "$UV_SHIMS_DIR/pip" << 'EOF'
#!/bin/bash
# UV Pip shim - uses UV-managed Python
uv_python=$(uv python find 2>/dev/null)
if [ -n "$uv_python" ]; then
    exec "$uv_python" -m pip "$@"
else
    exec /opt/homebrew/bin/python3 -m pip "$@" 2>/dev/null || exec /usr/bin/python3 -m pip "$@"
fi
EOF
        
        # Pip3 shim
        cat > "$UV_SHIMS_DIR/pip3" << 'EOF'
#!/bin/bash
# UV Pip3 shim - uses UV-managed Python
uv_python=$(uv python find 2>/dev/null)
if [ -n "$uv_python" ]; then
    exec "$uv_python" -m pip "$@"
else
    exec /opt/homebrew/bin/python3 -m pip "$@" 2>/dev/null || exec /usr/bin/python3 -m pip "$@"
fi
EOF
        
        # Make shims executable
        chmod +x "$UV_SHIMS_DIR"/{python,python3,pip,pip3}
    }
    
    # Create shims if they don't exist or are outdated
    if [ ! -f "$UV_SHIMS_DIR/python" ] || [ ! -f "$UV_SHIMS_DIR/python3" ]; then
        _create_uv_shims
    fi
    
    # Enhanced .python-version detection with visual feedback and file monitoring
    uv_check_version() {
        if [ -f ".python-version" ]; then
            local required_version=$(cat .python-version)
            local current_version=$(uv python find --show-version 2>/dev/null)
            if [ "$current_version" != "$required_version" ]; then
                echo "ðŸ Switching to Python $required_version (from $current_version)"
                uv python pin "$required_version" 2>/dev/null || echo "âš ï¸  Python $required_version not installed. Run: uv python install $required_version"
            fi
        fi
    }
    
    # Function to monitor .python-version file changes
    uv_monitor_python_version() {
        # Check if fswatch is available for file monitoring
        if command -v fswatch &> /dev/null; then
            # Kill any existing fswatch processes for .python-version
            pkill -f "fswatch.*\.python-version" 2>/dev/null || true
            
            # Start monitoring .python-version file in background
            if [ -f ".python-version" ]; then
                (fswatch -o .python-version 2>/dev/null | while read num; do
                    echo "ðŸ“ .python-version file changed, switching Python version..."
                    uv_check_version
                done) &
                disown
            fi
        fi
    }
    
    # Function to setup file monitoring when entering a directory
    uv_setup_monitoring() {
        uv_check_version
        uv_monitor_python_version
    }
    
    # Hook into directory changes for automatic version checking and monitoring
    autoload -U add-zsh-hook
    add-zsh-hook chpwd uv_setup_monitoring
    
    # Run once on shell startup
    uv_setup_monitoring
    
    # Function to manually refresh Python version (useful after editing .python-version)
    python-refresh() {
        echo "ðŸ”„ Refreshing Python version..."
        uv_check_version
        uv_monitor_python_version
        echo "âœ… Python version refreshed"
        echo "Current: $(python --version 2>/dev/null || echo 'Not found')"
    }
    
    # Alternative approach using periodic checking (if fswatch is not available)
    uv_periodic_check() {
        # Store the last modification time of .python-version
        if [ -f ".python-version" ]; then
            local current_mtime=$(stat -f %m .python-version 2>/dev/null || stat -c %Y .python-version 2>/dev/null)
            if [ -n "$current_mtime" ] && [ "$current_mtime" != "$UV_PYTHON_VERSION_MTIME" ]; then
                export UV_PYTHON_VERSION_MTIME="$current_mtime"
                echo "ðŸ“ .python-version file changed, switching Python version..."
                uv_check_version
            fi
        fi
    }
    
    # If fswatch is not available, use periodic checking
    if ! command -v fswatch &> /dev/null; then
        # Add periodic check to precmd (runs before each prompt)
        add-zsh-hook precmd uv_periodic_check
        
        # Initialize the modification time
        if [ -f ".python-version" ]; then
            export UV_PYTHON_VERSION_MTIME=$(stat -f %m .python-version 2>/dev/null || stat -c %Y .python-version 2>/dev/null)
        fi
    fi
    
    # Aliases for convenience
    alias python-versions="uv python list"
    alias python-install="uv python install"
    alias python-pin="uv python pin"
    alias python-current="uv python find --show-version"
    alias python-which="uv python find"
    alias python-path="uv python find"
    
    # Function to show all Python paths
    python-paths() {
        echo "ðŸ Python Path Information:"
        echo "=========================="
        echo ""
        echo "UV managed Python:"
        uv python find 2>/dev/null || echo "  No UV Python found"
        echo ""
        echo "UV shims (highest priority):"
        echo "  python: $UV_SHIMS_DIR/python"
        echo "  python3: $UV_SHIMS_DIR/python3"
        echo ""
        echo "System Python paths:"
        echo "  $(command which -a python 2>/dev/null | grep -v "$UV_SHIMS_DIR" | head -3 | tr '\n' ' ')"
        echo ""
        echo "System Python3 paths:"
        echo "  $(command which -a python3 2>/dev/null | grep -v "$UV_SHIMS_DIR" | head -3 | tr '\n' ' ')"
        echo ""
        echo "Current versions:"
        echo "  python: $(python --version 2>/dev/null || echo 'Not found')"
        echo "  python3: $(python3 --version 2>/dev/null || echo 'Not found')"
        echo ""
        if [ -f ".python-version" ]; then
            echo "Local .python-version: $(cat .python-version)"
        else
            echo "No .python-version file in current directory"
        fi
        echo ""
        echo "PATH priority:"
        echo "  1. UV shims: $UV_SHIMS_DIR"
        echo "  2. Homebrew: /opt/homebrew/bin"
        echo "  3. System: /usr/bin"
    }
    
    # Function to recreate shims (useful for updates)
    uv-recreate-shims() {
        echo "ðŸ”§ Recreating UV Python shims..."
        rm -f "$UV_SHIMS_DIR"/{python,python3,pip,pip3}
        _create_uv_shims
        echo "âœ… UV shims recreated in $UV_SHIMS_DIR"
        echo "ðŸ”„ Please restart your shell: exec \$SHELL -l"
    }
fi

# Node.js - fnm (faster than nvm)
if command -v fnm &> /dev/null; then
    eval "$(fnm env --use-on-cd)"
fi

# Go - Built-in version management
export GOPATH="$HOME/go"
export PATH="$GOPATH/bin:$PATH"

# Java - SDKMAN (best Java ecosystem manager)
[[ -s "$HOME/.sdkman/bin/sdkman-init.sh" ]] && source "$HOME/.sdkman/bin/sdkman-init.sh"

# Rust - rustup (official Rust toolchain)
[[ -s "$HOME/.cargo/env" ]] && source "$HOME/.cargo/env"

# ----------------------------------------------------------------------------
# Node.js - fnm (Fast Node Manager)
# ----------------------------------------------------------------------------
if command -v fnm &> /dev/null; then
    eval "$(fnm env --use-on-cd)"
fi

# ----------------------------------------------------------------------------
# Google Cloud Platform
# ----------------------------------------------------------------------------
source "/opt/homebrew/share/google-cloud-sdk/path.zsh.inc"
source "/opt/homebrew/share/google-cloud-sdk/completion.zsh.inc"

# ----------------------------------------------------------------------------
# Kubernetes
# ----------------------------------------------------------------------------
source <(kubectl completion zsh)
export KUBE_EDITOR="$(which nvim)"
export KUBECONFIG=~/.kube/config

# ----------------------------------------------------------------------------
# OpenAI API
# ----------------------------------------------------------------------------
export OPENAI_API_KEY=""
export OPENAI_ORGANIZATION_ID=""
export OPENAI_PROJECT_ID=""


# ============================================================================
# Aliases
# ============================================================================

# ----------------------------------------------------------------------------
# General Aliases
# ----------------------------------------------------------------------------
alias ls='ls -Gv'
alias ll='ls -lh'
alias la='ls -alh'
alias htop='sudo htop'

# ----------------------------------------------------------------------------
# Editor Aliases
# ----------------------------------------------------------------------------
alias nv='nvim'

# ----------------------------------------------------------------------------
# Terraform Aliases
# ----------------------------------------------------------------------------
alias terraform_precheck='terraform init -upgrade && terraform fmt && terraform validate;'


# ============================================================================
# Optional Configurations
# ============================================================================

# ----------------------------------------------------------------------------
# Less Color Configuration (Disabled)
# ----------------------------------------------------------------------------
#export LESS_TERMCAP_mb=$'\E[01;31m'       # begin blinking
#export LESS_TERMCAP_md=$'\E[01;38;5;74m'  # begin bold
#export LESS_TERMCAP_me=$'\E[0m'           # end mode
#export LESS_TERMCAP_se=$'\E[0m'           # end standout-mode
#export LESS_TERMCAP_so=$'\E[38;5;246m'    # begin standout-mode - info box
#export LESS_TERMCAP_ue=$'\E[0m'           # end underline
#export LESS_TERMCAP_us=$'\E[04;38;5;146m' # begin underline


# ============================================================================
# Amazon Q Integration (Post-initialization)
# ============================================================================
# NOTE: Keep at the bottom of this file
[[ -f "${HOME}/Library/Application Support/amazon-q/shell/zshrc.post.zsh" ]] && \
    builtin source "${HOME}/Library/Application Support/amazon-q/shell/zshrc.post.zsh"

# Added by Antigravity
export PATH="/Users/wlin/.antigravity/antigravity/bin:$PATH"


# Kiro CLI post block. Keep at the bottom of this file.
[[ -f "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.post.zsh" ]] && builtin source "${HOME}/Library/Application Support/kiro-cli/shell/zshrc.post.zsh"
